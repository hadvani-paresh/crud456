@{
    Layout = "_Layout";
    ViewData["Title"] = "Sign In";
}

<div class="row justify-content-center align-items-center animate-fade-in" style="min-height: 70vh;">
    <div class="col-md-5 col-lg-4">
        <div class="premium-card p-5">
            <div class="text-center mb-4">
                <div class="bg-primary bg-gradient rounded-circle d-inline-flex p-3 mb-3 shadow">
                    <i class="bi bi-shield-lock text-white fs-2"></i>
                </div>
                <h2 class="fw-bold mb-1">Welcome Back</h2>
                <p class="text-muted small">Enter your credentials to continue</p>
            </div>

            <form id="loginForm" novalidate>
                <div class="mb-3">
                    <label class="form-label fw-semibold small">Email Address</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0"><i class="bi bi-envelope"></i></span>
                        <input type="email" class="form-control form-control-premium" id="loginEmail" placeholder="name@example.com" required>
                        <div class="invalid-feedback">A valid email address is required.</div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="d-flex justify-content-between">
                        <label class="form-label fw-semibold small">Password</label>
                    </div>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0"><i class="bi bi-key"></i></span>
                        <input type="password" class="form-control form-control-premium" id="loginPassword" placeholder="••••••••" required>
                        <div class="invalid-feedback">Password is required.</div>
                    </div>
                </div>

                <div id="loginError" class="alert alert-danger d-none border-0 shadow-sm py-2 mb-3 small animate-fade-in"></div>

                <button type="submit" class="btn btn-premium w-100 py-3 mb-3">
                    <span id="loginBtnText">Login</span>
                    <span id="loginBtnLoader" class="spinner-border spinner-border-sm d-none"></span>
                </button>

                <div class="text-center mb-3">
                    <a href="/Account/ForgotPassword" class="text-muted small text-decoration-none">Forgot your password?</a>
                </div>

                <div class="text-center pt-3 border-top">
                    <p class="mb-0 text-muted small">Don't have an account?</p>
                    <a href="/Account/Register" class="text-primary fw-bold text-decoration-none">Create an Account</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const email = document.getElementById('loginEmail');
            const password = document.getElementById('loginPassword');
            const errorDiv = document.getElementById('loginError');
            const btnText = document.getElementById('loginBtnText');
            const btnLoader = document.getElementById('loginBtnLoader');
            
            errorDiv.classList.add('d-none');
            form.classList.remove('was-validated');

            // Collect errors for the summary at the bottom
            let errors = [];
            if (!email.value) {
                errors.push("Email Address is required.");
                email.classList.add('is-invalid');
            } else if (!email.checkValidity()) {
                errors.push("Please enter a valid email format.");
                email.classList.add('is-invalid');
            } else {
                email.classList.remove('is-invalid');
            }

            if (!password.value) {
                errors.push("Password is required.");
                password.classList.add('is-invalid');
            } else {
                password.classList.remove('is-invalid');
            }

            if (errors.length > 0) {
                errorDiv.innerHTML = `<ul class="mb-0 ps-3">${errors.map(err => `<li>${err}</li>`).join('')}</ul>`;
                errorDiv.classList.remove('d-none');
                return;
            }

            btnText.classList.add('d-none');
            btnLoader.classList.remove('d-none');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email.value, password: password.value })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('jwt_token', data.token);
                    localStorage.setItem('user_info', JSON.stringify(data.user));
                    window.location.href = '/Dashboard';
                } else {
                    const errorData = await response.json();
                    errorDiv.innerText = errorData.message || "Invalid credentials";
                    errorDiv.classList.remove('d-none');
                }
            } catch (error) {
                errorDiv.innerText = "Network error. Please try again.";
                errorDiv.classList.remove('d-none');
            } finally {
                btnText.classList.remove('d-none');
                btnLoader.classList.add('d-none');
            }
        });

        // Real-time validation
        document.getElementById('loginForm').addEventListener('input', (e) => {
            if (e.target.required) {
                e.target.classList.toggle('is-invalid', !e.target.value || !e.target.checkValidity());
                if (e.target.value && e.target.checkValidity()) {
                    e.target.classList.add('is-valid');
                } else {
                    e.target.classList.remove('is-valid');
                }
            }
        });
    </script>
}
